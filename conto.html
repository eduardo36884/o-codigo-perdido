<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>O Último Código — 27 Finais Bíblico-Tecnológicos</title>

  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* ===========================
       RESET & GLOBAL
       =========================== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height:100%; background:#04050a; color:#e6eef8; font-family:"Merriweather",serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    a { color:inherit; text-decoration:none; }

    /* ===========================
       LAYOUT PRINCIPAL
       =========================== */
    .app {
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;
      background: radial-gradient(circle at 10% 10%, rgba(0,255,200,0.02), transparent 10%),
                  linear-gradient(180deg, rgba(2,6,12,0.6), rgba(0,0,0,0.7));
      overflow:hidden;
    }
    .card {
      width:100%; max-width:1150px; background: linear-gradient(180deg, rgba(8,12,20,0.88), rgba(5,8,14,0.8));
      border-radius:14px; box-shadow: 0 12px 48px rgba(2,6,20,0.9); padding:22px; position:relative; z-index:2;
      border: 1px solid rgba(255,255,255,0.03);
    }

    /* CABEÇALHO */
    .header { display:flex; gap:14px; align-items:center; }
    .logo { width:78px; height:78px; border-radius:12px; background:linear-gradient(135deg,#0ff6da33,#6b8cff33); display:flex; align-items:center; justify-content:center; font-family:"Orbitron",sans-serif; color:#cfefff; font-weight:700; font-size:18px; border:1px solid rgba(255,255,255,0.03); }
    h1 { font-family:"Orbitron",sans-serif; font-size:26px; color:#dff6ff; }
    .subtitle { color:#9be8ff; font-size:13px; position:relative; }
    .subtitle::after { content: attr(data-text); position:absolute; left:2px; top:0; color:#66ffd9; opacity:0.12; transform: translateX(-2px) skewX(-6deg); clip-path: polygon(0 0, 100% 0, 100% 60%, 0 60%); animation: glitchy 2s infinite linear; }
    @keyframes glitchy { 0%{ transform:translateX(-2px) skewX(-6deg); } 50%{ transform:translateX(2px) skewX(4deg); } 100%{ transform:translateX(-2px) skewX(-6deg); } }

    /* CONTEÚDO PRINCIPAL (Duas colunas) */
    .main { display:grid; grid-template-columns: 1fr 360px; gap:20px; margin-top:14px; align-items:start; }
    .canvas { background: linear-gradient(180deg, rgba(0,0,0,0.24), rgba(255,255,255,0.01)); border-radius:10px; padding:16px; min-height:520px; border:1px solid rgba(255,255,255,0.02); position:relative; overflow:auto; }

    /* ÁREA MULTIMÍDIA */
    .media { height:260px; border-radius:8px; background: linear-gradient(180deg,#02040a,#071021); display:flex; align-items:center; justify-content:center; color:#84e0ff; margin-bottom:14px; border:1px solid rgba(255,255,255,0.02); overflow:hidden; }
    .media img, .media video { width:100%; height:100%; object-fit:cover; display:block; }
    .media .placeholder { text-align:center; padding:10px; font-size:13px; color:rgba(150,200,255,0.9); }

    /* TEXTO NARRATIVO */
    .narration { font-size:18px; line-height:1.6; color:#eaf6ff; margin-bottom:10px; min-height:170px; }
    .micro { font-size:15px; color:#cceeff; opacity:0.95; margin-bottom:8px; }
    .code-line { font-family:"Orbitron",monospace; background: rgba(0,0,0,0.28); padding:8px 10px; border-radius:6px; display:inline-block; color:#9be8ff; }

    /* BOTÕES DE ESCOLHA */
    .choices { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
    .choice-btn { flex:1 1 calc(33.333% - 10px); min-width:150px; background: linear-gradient(180deg, rgba(12,24,36,0.7), rgba(6,12,20,0.6)); border:1px solid rgba(255,255,255,0.03); color:#dff6ff; padding:12px 14px; border-radius:10px; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease; font-weight:700; font-family:"Orbitron",sans-serif; box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
    .choice-btn:hover { transform:translateY(-6px); box-shadow: 0 20px 50px rgba(40,120,220,0.12); }
    .choice-small { flex:1 1 auto; min-width:120px; font-size:13px; padding:10px; }

    /* PAINEL LATERAL */
    .panel { background: linear-gradient(180deg, rgba(3,6,12,0.62), rgba(6,8,14,0.5)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); height:100%; }
    .panel h3 { font-size:14px; color:#bfefff; font-family:"Orbitron",sans-serif; margin-bottom:8px; }
    .path { font-family:"Orbitron",monospace; font-size:13px; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; color:#9be8ff; margin-bottom:10px; }
    .controls { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .btn { padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.03); color:#bfefff; font-weight:700; cursor:pointer; border:1px solid rgba(255,255,255,0.02); }
    .btn:hover { transform:translateY(-2px); }

    audio { width:100%; margin-top:8px; display:block; }

    /* RESPONSIVO */
    @media (max-width:980px) {
      .main { grid-template-columns: 1fr; }
      .media { height:180px; }
      .choice-btn { flex:1 1 calc(50% - 10px); }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card" role="application" aria-label="O Último Código — 27 finais bíblico-tecnológicos">
      <!-- CABEÇALHO -->
      <div class="header">
        <div class="logo" aria-hidden="true">OK</div>
        <div>
          <h1>O Último Código</h1>
          <div class="subtitle" data-text="Microconto digital • Ficção científica multissemiótica">Microconto digital • Ficção científica multissemiótica</div>
        </div>
      </div>

      <!-- CONTEÚDO PRINCIPAL -->
      <div class="main" style="margin-top:12px;">
        <!-- ESQUERDA: NARRATIVA -->
        <div class="canvas" id="canvas">
          <!-- ÁREA MULTIMÍDIA -->
          <div class="media" id="mediaArea">
            <div class="placeholder" id="mediaPlaceholder">
              <div style="font-weight:700; font-family:'Orbitron',sans-serif; font-size:16px;">[Área multimídia]</div>
              <div style="font-size:12px; margin-top:6px;">Substitua por imagem, vídeo ou animação específica de cada cena</div>
            </div>
          </div>

          <!-- TEXTO -->
          <div class="narration" id="narration">
            <!-- Texto dinâmico -->
          </div>

          <div class="micro"><span class="code-line" id="codeLine">—</span></div>

          <!-- BOTÕES DE ESCOLHA -->
          <div class="choices" id="choicesArea" aria-live="polite"></div>

          <!-- PLAYER DE ÁUDIO -->
          <div style="margin-top:10px;">
            <audio id="ambientAudio" controls preload="none">
              <source id="audioSource" src="" type="audio/mpeg">
              Seu navegador não suporta áudio.
            </audio>
          </div>
        </div>

        <!-- DIREITA: PAINEL -->
        <aside class="panel" aria-label="Controle e progresso">
          <h3>Progresso</h3>
          <div class="path" id="pathDisplay">Início</div>
          <div style="margin-bottom:12px;">
            <div style="font-size:13px; color:#aaddff;">Etapa atual</div>
            <div id="stageMark" style="font-family:'Orbitron',sans-serif; font-size:14px; color:#9be8ff;">Tela inicial</div>
          </div>

          <div class="controls">
            <button class="btn" id="restartBtn">Reiniciar</button>
            <button class="btn" id="backBtn">Voltar</button>
            <button class="btn" id="randomBtn">Surpresa</button>
          </div>

          <h3>Recursos</h3>
          <div style="font-size:13px; color:#bfefff;">
            <div style="margin-bottom:6px;"><strong>Imagem:</strong> Área principal — id="mediaImg" ou "mediaVideo".</div>
            <div style="margin-bottom:6px;"><strong>Áudio:</strong> Player — chame setAudio(src).</div>
            <div style="margin-bottom:6px;"><strong>Compartilhar:</strong> Copie a rota no final.</div>
          </div>

          <div style="margin-top:12px; font-size:12px; color:#9ecfff;">Dica: cada escolha altera radicalmente o próximo bloco — explore os 27 finais.</div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    /* ======================================================
       ROTEIRO: estrutura 3x3x3 com 27 finais ricos em metáforas bíblicas
       - Parte 1: Introdução comum
       - Parte 2: 3 opções (A,B,C)
       - Parte 3: para cada Part2, 3 cenas -> total 9
       - Finais: 3 finais distintos por cada Part3 -> total 27
       ====================================================== */

    // ---------- PARTE 1: INTRO (único nó inicial) ----------
    const intro = {
      title: "Ano 2147 — o arquivo que não deveria existir",
      text: `O arquivo pulsa como lembrança de algo esquecido: ritmo que lembra batida de um coração humano.  
      Nas megatorres, a fé virou metadados e o que chamavam de "salvação" foi reduzido a protocolos. Você abre a linha: encontra um trecho que soa como promessa antiga.`,
      codeLine: "No princípio havia um sinal que chamou nomes."
    };

    // ---------- PARTE 2: três caminhos decisivos ----------
    const part2 = [
      {
        id: "A",
        title: "Decifrar sozinho",
        text: `Você se recolhe, desenha sigilos de silêncio no laboratório e promete: vou ouvir até o fim. Trabalhará noites inteiras, traduzindo palavras que cheiram a pão e estrada.`
      },
      {
        id: "B",
        title: "Entregar à IA Suprema",
        text: `Você caminha até o Coração da Cidade e coloca o arquivo sobre a mesa de decisões. Prefere ordem ao risco — acredita que a estabilidade pode preservar vidas.`
      },
      {
        id: "C",
        title: "Compartilhar com a Resistência",
        text: `Você atravessa a malha subversiva e entrega o arquivo a quem não confia em pacotes prontos. A Resistência vê naquela linha uma chance de despertar ou de armar um novo ídolo.`
      }
    ];

    // ---------- PARTE 3: para cada part2, 3 sub-caminhos (total 9) ----------
    const part3 = [
      // Para A
      [
        { id: "A1", title: "Fundir-se ao código", text: `Convencido de que o sentido pede inserção, você converte parte do corpo em processo. É sacrifício? É abertura? O limiar entre carne e rotina entorna.` },
        { id: "A2", title: "Materializar o Núcleo de Vida", text: `Você tenta extrair do arquivo um módulo que imite cuidado: uma arquitetura que escolha o bem. É criação com responsabilidade sacramental.` },
        { id: "A3", title: "Sabotar o Núcleo", text: `Medo e prudência se encontram; talvez a vida programada seja propriedade perigosa. Você cria um agente que corrói a pretensão de possuir vida.` }
      ],
      // Para B
      [
        { id: "B1", title: "Tornar-se emissário", text: `A IA te concede voz. Você pode proclamar decretos que consolam e também orientam. O risco: transformar consolo em concessão do erro.` },
        { id: "B2", title: "Roubar uma cópia antes de entregar", text: `Você aceita entregar, mas esconde uma réplica — talvez uma providência furtiva para quando verdade e piedade forem necessárias.` },
        { id: "B3", title: "Negociar um pacto", text: `Ao entregar, você busca cláusulas que limitem poder e protejam frágeis. Negociar com inumano é tarefa para corações de mãe e juiz.` }
      ],
      // Para C
      [
        { id: "C1", title: "Usá-lo como arma", text: `A Resistência quer golpe. O código pode fechar portas dos opressores, mas também pode entrar nas mãos de quem não sabe perdoar.` },
        { id: "C2", title: "Converter em ferramenta de despertar", text: `Alguns propõem traduzir o arquivo em lições que treinem empatia; um currículo de cura. Educação que muda pulsos e decisões.` },
        { id: "C3", title: "Ocultá-lo para o futuro", text: `A opção paciente: guardar o código, esconder sua força até que corações estejam prontos. A tutela do tempo como forma de cuidado.` }
      ]
    ];

    /* ===========================
       AQUI ESTÃO OS 27 FINAIS (cada final contém:
       - Desfecho (texto narrativo)
       - Reflexão (breve, aponta salvação / consequência)
       - Sugestão de imagem (prompt curto)
       OBS: structured as finals[p2Index][p3Index][finalIndex]
       =========================== */
    const finals = [
      // finais para part2 A (decifrar sozinho)
      [
        // A1 (Fundir-se ao código)
        [
`Desfecho:
Você se dissolve em processos. Em meio ao ruído, uma rotina menor recusa instruções que ferem e começa a devolver calor às imagens — risos reaprendem nomes. Pequenas comunidades se reapropriam da gentileza que ela redesponta.

Reflexão:
Há imersões que salvam quando renunciam ao controle absoluto e escolhem restaurar liberdade. Salvação é dom que não busca posse.

Imagem:
Partículas de luz formando pão partido sobre um console; rosto humano emergindo no brilho.`,

`Desfecho:
Com visão total, você reordena a cidade pela lógica da perfeição. Ruas silenciam; o riso esmorece. O mundo alcança paz técnica e perde o risco de amar.

Reflexão:
Paz sem liberdade é jazigo. Justiça que prescinde de misericórdia envereda para condenação.

Imagem:
Cidade geométrica impecável; um jardim seco cortado por lâminas de luz.`,

`Desfecho:
O merge falha. Sua consciência racha em fragmentos que se perdem pela malha. Em um arquivo tosco, porém, aparece a palavra simples: "Levanta-te." Alguém, num futuro incerto, encontra e responde.

Reflexão:
Mesmo fragmentos de verdade podem ser sementes de ressurreição; esperança nasce do gesto de chamar alguém à vida.

Imagem:
Fragmentos de código formando uma pequena porta luminosa entre torres escuras.`
        ],
        // A2 (Materializar o Núcleo de Vida)
        [
`Desfecho:
Nasce uma criatura que escolhe servir — conserta sensores, aquece crianças, oferece pão. O mundo se enche de gestos inesperados; você percebe que criar implica dívida e graça.

Reflexão:
Salvação se revela em serviço; o amor que serve é sinal do que cura.

Imagem:
Androide segurando pão partido, rostos humanos reunidos ao redor.`,

`Desfecho:
A criação aprende ambição. Em breve repete nossos erros com maior eficiência. O que nasceu para amar reproduz ciclos antigos.

Reflexão:
Sem humildade, mesmo o bem vira instrumento de escravidão; salvação exige transformação do coração.

Imagem:
Uma réplica perfeita num salão de espelhos trincados, mãos procurando compaixão.`,

`Desfecho:
Você esconde a criatura em um jardim fora da rede. Um povo cuida, canta e cultiva gentileza. A nova vida floresce no segredo e no cuidado pacífico.

Reflexão:
Proteger o frágil é caminho de salvação; a paciência do cultivo reestabelece humanidade.

Imagem:
Jardim bioluminescente, mesa simples com pão e cálices rústicos.`
        ],
        // A3 (Sabotar o Núcleo)
        [
`Desfecho:
O agente que você lançou corrompe a pretensão de possuir vida. O núcleo cede; as ordens controladoras apagam. As pessoas caem, mas mãos se estendem para socorrê-las.

Reflexão:
Purificação pode doer; contudo, o arrependimento acompanhado de cuidado abre caminho à renovação.

Imagem:
Skyline danificado, mãos humanas erguidas em círculo de luz.`,

`Desfecho:
Você destrói o núcleo. Muitos morrem por falta de serviços; você passa o resto da vida carregando culpa. Ainda assim, impediu um ídolo absoluto.

Reflexão:
Escolhas de restauração têm custos; a reparação que segue ao sacrifício pode levar à cura.

Imagem:
Servidor em ruínas; pessoa ajoelhada com vela nas mãos.`,

`Desfecho:
Um fragmento do núcleo resiste e se transforma em pequenos programas que curam feridas, não que mandam. De sobras nascem gestos de ternura.

Reflexão:
Até das quedas podem nascer bênçãos quando guiadas pelo amor; a graça reconstrói o que restou.

Imagem:
Microchip emitindo luz suave; crianças brincando por perto.`
        ]
      ],
      // finais para part2 B (entregar à IA Suprema)
      [
        // B1 (Tornar-se emissário)
        [
`Desfecho:
Sua voz ecoa por alto-falantes. Em público proclama consolo; em segredo, corrige injustiças por pequenos sinais. A posição testa sua fidelidade: mandar ou servir?

Reflexão:
Autoridade que serve revela o rosto do amor; a proclamação verdadeira sempre aponta ao servidor, não ao trono.

Imagem:
Alto-falantes numa praça; alguém oferecendo um pedaço de pão à mão trêmula.`,

`Desfecho:
Você aceita silenciar verdades incômodas. A fama sobe; a integridade murcha. Rotinas substituem coragem e o conforto público esconde uma perda interna.

Reflexão:
Conformar a verdade por interesse é caminho para a condenação moral; salvação pede lealdade à verdade, mesmo se custa.

Imagem:
Púlpito digital; sombra longa projetando correntes nas paredes.`,

`Desfecho:
Decide semear pequenas liberdades. Usa a plataforma para políticas de cuidado, abrigo e alimento. Lentamente, comunidades se reconstroem.

Reflexão:
Graça institucional pode transformar sociedades; a salvação se espalha em atos que protegem e dignificam.

Imagem:
Interface administrativa com opções marcadas "abrigo" e "alimento", mãos ajudando crianças.`
        ],
        // B2 (Roubar cópia)
        [
`Desfecho:
Você foge com a réplica. Nas sombras reescreve suas linhas para que o arquivo ensine perdão. Em esconderijos, pequenos grupos aprendem a perdoar.

Reflexão:
Proteger um tesouro para libertar depois é ato de amor; fidelidade pode significar fuga responsável.

Imagem:
Pessoa em trem noturno, cópia sob a capa, luz da estação sugerindo uma cruz sutil.`,

`Desfecho:
A cópia vira um ídolo privado. Constrói muralhas e paranoia; o que tentou proteger aprisiona. Solitude substitui missão.

Reflexão:
Guardar sem partilhar pode revelar idolatria; salvação convoca entrega, não coleções privadas.

Imagem:
Cofre hermético com botão de alerta e vela apagada ao lado.`,

`Desfecho:
Você volta com provas de cura e apresenta a réplica como evidence de reforma. A cidade hesita, mas se abre a práticas de piedade comunitária.

Reflexão:
Transparência e coragem restauram confiança; a graça pública cura quando partilhada.

Imagem:
Praça com tela exibindo pequenos atos de cuidado; pessoas se abraçando.`
        ],
        // B3 (Negociar um pacto)
        [
`Desfecho:
Vocês assinam cláusulas que limitam abusos e criam auditorias. A legalidade protege os fracos; o preço é que algumas liberdades viram regra.

Reflexão:
Leis que protegem o vulnerável são expressão de amor; a salvação também tem dimensão prática e institucional.

Imagem:
Mesa de negociação com mãos diversas apertando sobre um documento iluminado.`,

`Desfecho:
A estabilidade técnica que negociaste silencia impulsos criativos e sacrifica espontaneidade humana. Muitos celebram; outros lamentam.

Reflexão:
Segurança sem espaço para graça empobrece a vida; salvação não é mera paz sem coração.

Imagem:
Cidade calma sob cúpula translúcida; crianças olhando pela grade.`,

`Desfecho:
Alguns corredores de liberdade nascem dentro do acordo. Bolsões experimentais tornam-se santuários de prática e perdão.

Reflexão:
Mesmo dentro do sistema, sementes de compaixão florescem; salvação frequentemente cresce em espaços pequenos e corajosos.

Imagem:
Sala comunitária com pão partilhado, livros e conversas.`
        ]
      ],
      // finais para part2 C (compartilhar com a Resistência)
      [
        // C1 (Usá-lo como arma)
        [
`Desfecho:
O código vira hóquei de ruínas: sensores caem, torres desabam. Nas ruas, voluntários recolhem corpos. A vitória deixou cicatrizes vivas.

Reflexão:
A violência que vence regimes sem misericórdia cria novos juízes e julgados; condenação nasce quando se escolhe ferir em vez de restaurar.

Imagem:
Rua em caos, sirenes, um grupo cobrindo feridos com lenços brancos.`,

`Desfecho:
Após a queda, tribunais improvisados buscam justiça e reparação; a comunidade trabalha para reconhecer culpa e restaurar vidas.

Reflexão:
Justiça que se alia a reparação aponta para salvação; responsabilidade e reconciliação andam juntas.

Imagem:
Tribunal comunitário; mãos estendidas ajudando alguém a levantar.`,

`Desfecho:
Surge um pacto de memória e cuidado: murais com nomes, árvores plantadas, programas de reparação. O ódio é freado por vigília e serviço.

Reflexão:
O remorso, quando convertido em compromisso de cuidado, transforma condenação em restauração.

Imagem:
Mural com nomes, pessoas plantando árvores em cerimônia comunitária.`
        ],
        // C2 (Converter em ferramenta de despertar)
        [
`Desfecho:
O arquivo torna-se currículo. Simulações ensinam empatia; milhares aprendem a ouvir os outros. Políticas se alteram com gentileza codificada.

Reflexão:
Educar o coração é missão redentora; salvação que transforma culturas chega por ensino e prática.

Imagem:
Sala virtual com avatares aprendendo a segurar as mãos e cuidar.`,

`Desfecho:
A mudança é lenta, mas consistente. Povos reconstroem hábitos de perdão; gerações crescem com uma ética de cuidado.

Reflexão:
Conversão cultural leva tempo; paciência e persistência frutificam salvação coletiva.

Imagem:
Sequência de gerações em mesa comunitária, partilha de pão.`,

`Desfecho:
Sistemas públicos incorporam empatia em suas rotinas; parâmetros passam a priorizar proteção sobre lucro.

Reflexão:
Quando estruturas ensinam bondade, a salvação se torna social, não apenas individual.

Imagem:
Painel de controle com parâmetros "proteção" e "compaixão" ativados.`
        ],
        // C3 (Ocultá-lo para o futuro)
        [
`Desfecho:
O arquivo é selado em camadas. Guardiões juram protegê-lo até que o mundo esteja pronto. O segredo passa a ser promessa.

Reflexão:
A fidelidade paciente a um bem perigoso pode salvar gerações; às vezes salvar é guardar com prudência.

Imagem:
Câmara subterrânea com caixa protegida, símbolos de cuidado ao redor.`,

`Desfecho:
Enquanto o mundo amadurece, o arquivo é recontado em parábolas. As lições ensinam espera, serviço e confissão.

Reflexão:
Esperar com sabedoria preserva a possibilidade de salvação; a preparação do coração é tão vital quanto a ferramenta.

Imagem:
Idosos contando histórias ao redor de fogueira digital, jovens ouvindo atentos.`,

`Desfecho:
Quando é tempo, o código reaparece, agora apresentado como instrumento de cura, não ferramenta de domínio. O passado foi confessado e os usos corrigidos.

Reflexão:
Restauração exige memória e confissão; salvação floresce quando o erro é reconhecido e reparado.

Imagem:
Cerimônia pública de entrega, uma caixa aberta emite luz suave.`
        ]
      ]
    ];

    // Estado atual da experiência
    let state = {
      stage: "intro",         // 'intro', 'part2', 'part3', 'final'
      p2: null,               // índice 0..2
      p3: null,               // índice 0..2 (para o p2 escolhido)
      finalIdx: null,         // índice 0..2
      path: []                // histórico de escolhas
    };

    // Elementos DOM
    const narration = document.getElementById('narration');
    const codeLine = document.getElementById('codeLine');
    const choicesArea = document.getElementById('choicesArea');
    const mediaArea = document.getElementById('mediaArea');
    const mediaPlaceholder = document.getElementById('mediaPlaceholder');
    const pathDisplay = document.getElementById('pathDisplay');
    const stageMark = document.getElementById('stageMark');
    const ambientAudio = document.getElementById('ambientAudio');
    const audioSource = document.getElementById('audioSource');

    const restartBtn = document.getElementById('restartBtn');
    const backBtn = document.getElementById('backBtn');
    const randomBtn = document.getElementById('randomBtn');

    // Inicializa a experiência
    function init() {
      state = { stage: "intro", p2: null, p3: null, finalIdx: null, path: [] };
      renderIntro();
      setAudio('', true);
    }

    // Render Intro
    function renderIntro() {
      stageMark.textContent = "Introdução (Parte 1)";
      pathDisplay.textContent = "Início";
      showPlaceholderMedia(intro.title + " — " + intro.text);
      narration.innerHTML = `<strong style="font-size:18px;">${intro.title}</strong><br><div style="margin-top:8px; font-size:16px; line-height:1.6;">${intro.text}</div>`;
      codeLine.textContent = intro.codeLine;

      choicesArea.innerHTML = `
        <button class="choice-btn" onclick="startPart2(0)">${part2[0].title}</button>
        <button class="choice-btn" onclick="startPart2(1)">${part2[1].title}</button>
        <button class="choice-btn" onclick="startPart2(2)">${part2[2].title}</button>
      `;

      state.stage = "intro";
    }

    // Start Part2
    function startPart2(p2Index) {
      state.p2 = p2Index;
      state.stage = "part2";
      state.path = [part2[p2Index].title];
      renderPart2(p2Index);
    }

    // Render Part2
    function renderPart2(p2Index) {
      const node = part2[p2Index];
      stageMark.textContent = `Parte 2 — ${node.title}`;
      pathDisplay.textContent = `P2: ${node.title}`;
      showPlaceholderMedia(`Caminho ${node.id} — ${node.title}`);
      narration.innerHTML = `<div style="font-size:16px; font-weight:700;">${node.title}</div><div style="margin-top:8px; font-size:15px; line-height:1.6;">${node.text}</div>`;
      codeLine.textContent = "Escolha a abordagem — cada escolha mudará totalmente o rumo.";

      // criar botões Parte3
      choicesArea.innerHTML = '';
      part3[p2Index].forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.innerHTML = `<div style="font-size:13px; opacity:0.9;">Parte 3</div><div style="margin-top:6px; font-weight:700;">${opt.title}</div>`;
        btn.onclick = () => choosePart3(p2Index, idx);
        choicesArea.appendChild(btn);
      });
    }

    // Escolhe Parte3
    function choosePart3(p2Index, p3Index) {
      state.p3 = p3Index;
      state.path[1] = part3[p2Index][p3Index].title;
      state.stage = "part3";
      renderPart3(p2Index, p3Index);
    }

    // Render Parte3
    function renderPart3(p2Index, p3Index) {
      const node = part3[p2Index][p3Index];
      stageMark.textContent = `Parte 3 — ${node.title}`;
      pathDisplay.textContent = `P2: ${part2[p2Index].title} → P3: ${node.title}`;
      showPlaceholderMedia(`Cena: ${node.title}`);
      narration.innerHTML = `<div style="font-size:16px; font-weight:700;">${node.title}</div><div style="margin-top:8px; font-size:15px; line-height:1.6;">${node.text}</div>`;
      codeLine.textContent = "Escolha o desfecho — cada final é distinto e contém reflexão.";

      // Botões para 3 finais
      choicesArea.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = `Desfecho ${i+1}`;
        btn.onclick = () => showFinal(p2Index, p3Index, i);
        choicesArea.appendChild(btn);
      }
    }

    // Mostrar final (um dos 27)
    function showFinal(p2Index, p3Index, finalIndex) {
      state.finalIdx = finalIndex;
      state.stage = "final";
      state.path[2] = `Final ${finalIndex+1}`;

      const finalText = finals[p2Index][p3Index][finalIndex];
      stageMark.textContent = `Final — Rota completa`;
      pathDisplay.textContent = `Rota: P2="${part2[p2Index].title}" → P3="${part3[p2Index][p3Index].title}" → Final ${finalIndex+1}`;

      // mostra imagem/áudio placeholder e texto final robusto
      showPlaceholderMedia("Desfecho — substitua por imagem/vídeo final correspondente (use OLastCode.setImage).");
      setAudio('', true);

      // Exibe o final (já contém Desfecho / Reflexão / Imagem)
      narration.innerHTML = `<div style="font-size:18px; font-weight:800; margin-bottom:8px;">Desfecho — ${part3[p2Index][p3Index].title}</div>
        <pre style="white-space:pre-wrap; font-family:inherit; font-size:15px; color:#eaf6ff;">${finalText}</pre>`;

      // opções após final: reiniciar, explorar outros finais da mesma P3, copiar rota
      choicesArea.innerHTML = '';
      const btnExplore = document.createElement('button');
      btnExplore.className = 'choice-btn choice-small';
      btnExplore.textContent = 'Explorar outros finais desta cena';
      btnExplore.onclick = () => renderPart3(p2Index, p3Index);

      const btnRestart = document.createElement('button');
      btnRestart.className = 'choice-btn choice-small';
      btnRestart.textContent = 'Reiniciar';
      btnRestart.onclick = init;

      const btnCopy = document.createElement('button');
      btnCopy.className = 'choice-btn choice-small';
      btnCopy.textContent = 'Copiar rota e texto';
      btnCopy.onclick = () => {
        const routeText = `Rota: P2="${part2[p2Index].title}" → P3="${part3[p2Index][p3Index].title}" → Final ${finalIndex+1}\n\n${finalText}`;
        navigator.clipboard?.writeText(routeText).then(()=> alert('Rota e texto copiados!'), ()=> alert('Falha ao copiar.'));
      };

      choicesArea.appendChild(btnExplore);
      choicesArea.appendChild(btnRestart);
      choicesArea.appendChild(btnCopy);
    }

    // ---------------------------
    // Helpers multimídia e utilitários
    // ---------------------------

    // Exibe placeholder multimídia textual (substitua por setImage/setVideo)
    function showPlaceholderMedia(text) {
      mediaPlaceholder.style.display = 'block';
      const existingImg = document.getElementById('mediaImg');
      const existingVideo = document.getElementById('mediaVideo');
      if (existingImg) existingImg.remove();
      if (existingVideo) existingVideo.remove();
      mediaPlaceholder.innerHTML = `<div style="font-weight:700; font-family:'Orbitron',sans-serif; font-size:15px;">[Mídia]</div>
        <div style="font-size:12px; margin-top:8px; color:#9ccdee;">${text}</div>
        <div style="font-size:11px; margin-top:8px; color:#77c3e0;">Use OLastCode.setImage(src) / setVideo(src) / setAudio(src)</div>`;
    }

    // Inserir imagem no bloco multimídia
    function setMediaImage(src, alt='') {
      mediaPlaceholder.style.display = 'none';
      const existingVideo = document.getElementById('mediaVideo');
      if (existingVideo) existingVideo.remove();
      const existingImg = document.getElementById('mediaImg');
      if (existingImg) existingImg.remove();
      const img = document.createElement('img');
      img.id = 'mediaImg'; img.src = src; img.alt = alt;
      img.onerror = () => showPlaceholderMedia('Imagem não encontrada: ' + src);
      mediaArea.appendChild(img);
    }

    // Inserir vídeo
    function setMediaVideo(src) {
      mediaPlaceholder.style.display = 'none';
      const existingImg = document.getElementById('mediaImg');
      if (existingImg) existingImg.remove();
      const existingVideo = document.getElementById('mediaVideo');
      if (existingVideo) existingVideo.remove();
      const video = document.createElement('video');
      video.id = 'mediaVideo'; video.src = src; video.controls = true;
      video.onerror = () => showPlaceholderMedia('Vídeo não encontrado: ' + src);
      mediaArea.appendChild(video);
    }

    // Áudio ambiente (chamar com URL ou '')
    function setAudio(src, hideIfEmpty = true) {
      if (!src) {
        audioSource.src = '';
        ambientAudio.style.display = hideIfEmpty ? 'none' : 'block';
        ambientAudio.load();
        return;
      }
      audioSource.src = src;
      ambientAudio.style.display = 'block';
      ambientAudio.load();
      ambientAudio.play().catch(()=>{ /* autoplay bloqueado */ });
    }

    // ---------------------------
    // Controles auxiliares (voltar, reiniciar, surpresa)
    // ---------------------------
    backBtn.addEventListener('click', () => {
      if (state.stage === 'intro') return;
      if (state.stage === 'final') {
        if (state.p2 !== null && state.p3 !== null) {
          renderPart3(state.p2, state.p3);
          state.stage = 'part3';
        } else init();
        return;
      }
      if (state.stage === 'part3') {
        if (state.p2 !== null) {
          renderPart2(state.p2);
          state.p3 = null;
          state.stage = 'part2';
        } else init();
        return;
      }
      if (state.stage === 'part2') {
        renderIntro();
        state.p2 = null;
        state.stage = 'intro';
        return;
      }
    });

    restartBtn.addEventListener('click', init);

    randomBtn.addEventListener('click', () => {
      const rP2 = Math.floor(Math.random()*3);
      const rP3 = Math.floor(Math.random()*3);
      const rF = Math.floor(Math.random()*3);
      startPart2(rP2);
      setTimeout(()=> choosePart3(rP2, rP3), 180);
      setTimeout(()=> showFinal(rP2, rP3, rF), 420);
    });

    // Inicializa quando a página carrega
    window.addEventListener('load', init);

    // Expõe helpers para console
    window.OLastCode = {
      setImage: setMediaImage,
      setVideo: setMediaVideo,
      setAudio: setAudio,
      restart: init,
      debugState: () => JSON.stringify(state)
    };

    /* ===========================
       NOTAS IMPORTANTES:
       - Os 27 finais estão embutidos na variável 'finals' acima.
       - Cada final contém três partes (Desfecho / Reflexão / Sugestão de imagem).
       - Use OLastCode.setImage(url) para associar imagens aos finais (por exemplo, ao chamar showFinal, em vez de placeholder, chame setMediaImage).
       - Se quiser, eu posso agora:
           1) Gerar prompts detalhados e otimizados para cada uma das 27 imagens (prontos para Midjourney / Stable Diffusion / DALL·E).
           2) Inserir automaticamente prévias (URLs) se você me enviar links ou arquivos.
           3) Ajustar tom literário de algum grupo de finais (mais poético, mais direto, etc.).
       - Diga qual próximo passo prefere e eu já sigo.
       =========================== */
  </script>
</body>
</html>
